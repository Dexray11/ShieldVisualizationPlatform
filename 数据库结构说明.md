# 盾构地质可视化平台 - 数据库结构说明

## 概览

本系统使用 SQLite 数据库，包含 **11 张核心表**，主要围绕项目管理、地质数据、盾构施工参数展开。

### 数据库文件位置
- 路径：`应用程序目录/data/shield_platform.db`
- 类型：SQLite 3.x

---

## 表结构详细说明

### 1. users（用户表）
**用途**：存储系统用户信息，用于登录认证和权限管理

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| user_id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 用户ID（主键） |
| username | VARCHAR(50) | UNIQUE, NOT NULL | 用户名（唯一） |
| password_hash | VARCHAR(255) | NOT NULL | 密码哈希值（SHA-256） |
| phone | VARCHAR(20) | - | 手机号 |
| role | VARCHAR(20) | DEFAULT 'viewer' | 角色（admin/engineer/viewer） |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| last_login | DATETIME | - | 最后登录时间 |

**默认数据**：
- admin / admin123（管理员）
- engineer / eng123（工程师）
- viewer / view123（查看者）

---

### 2. projects（项目表）
**用途**：存储盾构隧道工程项目的基本信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| project_id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 项目ID（主键） |
| project_name | VARCHAR(100) | NOT NULL | 项目名称 |
| brief | TEXT | - | 项目简介 |
| latitude | REAL | - | 纬度（地图定位） |
| longitude | REAL | - | 经度（地图定位） |
| construction_unit | VARCHAR(100) | - | 施工单位 |
| start_date | DATE | - | 开始日期 |
| progress | REAL | DEFAULT 0 | 施工进度（百分比） |
| location | VARCHAR(200) | - | 地理位置描述 |
| status | VARCHAR(20) | DEFAULT 'active' | 状态（active/completed/paused） |
| map_2d_path | VARCHAR(500) | - | 二维地质图路径 |
| map_3d_path | VARCHAR(500) | - | 三维地质图路径 |
| emergency_contact1_name | VARCHAR(50) | - | 紧急联系人1姓名 |
| emergency_contact1_phone | VARCHAR(20) | - | 紧急联系人1电话 |
| emergency_contact2_name | VARCHAR(50) | - | 紧急联系人2姓名 |
| emergency_contact2_phone | VARCHAR(20) | - | 紧急联系人2电话 |
| current_mileage | REAL | DEFAULT 0 | 当前掘进里程（米） |
| start_mileage | REAL | DEFAULT 0 | 起始里程（米） |
| end_mileage | REAL | DEFAULT 0 | 终止里程（米） |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

**关联关系**：
- 一对多：一个项目可有多个预警(warnings)
- 一对多：一个项目可有多个钻孔(boreholes)
- 一对多：一个项目可有多条隧道轮廓(tunnel_profiles)
- 一对多：一个项目可有多个里程点(mileage_points)
- 一对一：一个项目对应一个盾构机位置(shield_position)
- 一对多：一个项目可有多条掘进参数记录(excavation_parameters)
- 一对多：一个项目可有多条补勘数据(prospecting_data)

---

### 3. warnings（预警信息表）
**用途**：存储施工过程中的地质风险预警信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| warning_id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 预警ID（主键） |
| project_id | INTEGER | NOT NULL, FOREIGN KEY | 项目ID（外键→projects） |
| warning_number | INTEGER | - | 预警编号 |
| warning_level | VARCHAR(10) | - | 预警级别（A/B/C/D） |
| warning_type | VARCHAR(50) | - | 预警类型（岩溶发育/涌水涌泥/岩层断裂/瓦斯区域） |
| latitude | REAL | - | 预警位置纬度 |
| longitude | REAL | - | 预警位置经度 |
| depth | REAL | - | 预警深度（米） |
| threshold_value | INTEGER | - | 预警阈值 |
| distance | REAL | - | 距离当前位置（米，负值表示已过） |
| warning_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 预警时间 |

**关联关系**：
- 多对一：多个预警属于一个项目(projects)

---

### 4. news（新闻表）
**用途**：存储平台发布的新闻公告信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| news_id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 新闻ID（主键） |
| news_content | TEXT | NOT NULL | 新闻内容 |
| publish_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 发布时间 |
| created_by | INTEGER | FOREIGN KEY | 创建者ID（外键→users） |

**关联关系**：
- 多对一：多条新闻由一个用户创建(users)

---

### 5. boreholes（钻孔表）
**用途**：存储地质勘探钻孔的基本信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| borehole_id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 钻孔ID（主键） |
| project_id | INTEGER | NOT NULL, FOREIGN KEY | 项目ID（外键→projects） |
| borehole_code | VARCHAR(50) | NOT NULL | 钻孔编号 |
| x_coordinate | REAL | - | X坐标 |
| y_coordinate | REAL | - | Y坐标 |
| surface_elevation | REAL | - | 地面高程（米） |
| mileage | REAL | - | 对应里程（米） |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**关联关系**：
- 多对一：多个钻孔属于一个项目(projects)
- 一对多：一个钻孔包含多个地层(borehole_layers)

---

### 6. borehole_layers（钻孔地层表）
**用途**：存储钻孔揭示的各地层详细信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| layer_id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 地层ID（主键） |
| borehole_id | INTEGER | NOT NULL, FOREIGN KEY | 钻孔ID（外键→boreholes） |
| layer_number | INTEGER | - | 地层编号 |
| layer_code | VARCHAR(20) | - | 地层代码 |
| era_genesis | VARCHAR(50) | - | 时代成因 |
| rock_name | VARCHAR(100) | - | 岩土名称 |
| bottom_elevation | REAL | - | 底板高程（米） |
| bottom_depth | REAL | - | 底板深度（米） |
| thickness | REAL | - | 厚度（米） |
| characteristics | TEXT | - | 特征描述 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**关联关系**：
- 多对一：多个地层属于一个钻孔(boreholes)

**CSV导入格式**（起大区间_钻孔数据.csv）：
```
钻孔编号,X坐标,Y坐标,地面高程,层号,层底高程,层底深度,厚度,时代成因,岩土名称,特征描述
```

---

### 7. tunnel_profiles（隧道轮廓表）
**用途**：存储隧道横断面的四个角点坐标信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| profile_id | INTEGER | PRIMARY KEY, AUTOINCREMENT | 轮廓ID（主键） |
| project_id | INTEGER | NOT NULL, FOREIGN KEY | 项目ID（外键→projects） |
| near_borehole | VARCHAR(50) | - | 临近钻孔编号 |
| mileage | REAL | - | 里程（米） |
| top_left_x | REAL | - | 左上角X坐标 |
| top_left_y | REAL | - | 左上角Y坐标 |
| top_left_z | REAL | - | 左上角Z坐标（高程） |
| bottom_left_x | REAL | - | 左下角X坐标 |
| bottom_left_y | REAL | - | 左下角Y坐标 |
| bottom_left_z | REAL | - | 左下角Z坐标（高程） |
| top_right_x | REAL | - | 右上角X坐标 |
| top_right_y | REAL | - | 右上角Y坐标 |
| top_right_z | REAL | - | 右上角Z坐标（高程） |
| bottom_right_x | REAL | - | 右下角X坐标 |
| bottom_right_y | REAL | - | 右下角Y坐标 |
| bottom_right_z | REAL | - | 右下角Z坐标（高程） |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**关联关系**：
- 多对一：多条轮廓属于一个项目(projects)

**CSV导入格式**（隧道线形_轮廓数据.csv）：
```
临近钻孔,里程,左上X,左上Y,左上Z,左下X,左下Y,左下Z,右上X,右上Y,右上Z,右下X,右下Y,右下Z
```

---

### 8. mileage_points（里程点表）
**用途**：存储隧道中心线上的里程点坐标信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | ID（主键） |
| project_id | INTEGER | NOT NULL, FOREIGN KEY | 项目ID（外键→projects） |
| stake_mark | VARCHAR(50) | - | 桩号（如K3+086.00） |
| mileage | REAL | - | 里程（米） |
| latitude | REAL | - | 纬度 |
| longitude | REAL | - | 经度 |
| elevation | REAL | - | 高程（米） |
| near_borehole | VARCHAR(50) | - | 临近钻孔编号 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**关联关系**：
- 多对一：多个里程点属于一个项目(projects)

**说明**：
- 用于地图定位和盾构机位置校准
- 系统会根据项目起止里程自动生成（每10米一个点）

---

### 9. shield_position（盾构机位置表）
**用途**：存储盾构机当前位置和上一次位置信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | ID（主键） |
| project_id | INTEGER | NOT NULL, UNIQUE, FOREIGN KEY | 项目ID（外键→projects，唯一） |
| front_latitude | REAL | - | 前盾纬度 |
| front_longitude | REAL | - | 前盾经度 |
| front_stake_mark | VARCHAR(50) | - | 前盾桩号 |
| rear_latitude | REAL | - | 盾尾纬度 |
| rear_longitude | REAL | - | 盾尾经度 |
| rear_stake_mark | VARCHAR(50) | - | 盾尾桩号 |
| depth | REAL | - | 埋深（米） |
| inclination | REAL | - | 倾角（度） |
| positioning_method | INTEGER | - | 定位方式（1:GPS 2:桩号 3:坐标） |
| previous_front_latitude | REAL | - | 上次前盾纬度 |
| previous_front_longitude | REAL | - | 上次前盾经度 |
| previous_front_stake_mark | VARCHAR(50) | - | 上次前盾桩号 |
| previous_rear_latitude | REAL | - | 上次盾尾纬度 |
| previous_rear_longitude | REAL | - | 上次盾尾经度 |
| previous_rear_stake_mark | VARCHAR(50) | - | 上次盾尾桩号 |
| previous_depth | REAL | - | 上次埋深（米） |
| previous_inclination | REAL | - | 上次倾角（度） |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

**关联关系**：
- 一对一：每个项目对应唯一的盾构机位置记录(projects)

**特点**：
- 每个项目只有一条记录（UNIQUE约束）
- 更新位置时，当前位置会保存到previous字段，新位置写入当前字段
- 支持三种定位方式的切换

---

### 10. excavation_parameters（掘进参数表）
**用途**：存储盾构机掘进过程的实时参数数据

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | ID（主键） |
| project_id | INTEGER | NOT NULL, FOREIGN KEY | 项目ID（外键→projects） |
| excavation_time | DATETIME | NOT NULL | 掘进时间 |
| stake_mark | VARCHAR(50) | - | 桩号 |
| mileage | REAL | - | 里程（米） |
| excavation_mode | VARCHAR(50) | - | 掘进模式（土压平衡/泥水平衡等） |
| chamber_pressure | REAL | - | 土仓土压力（MPa） |
| thrust_force | REAL | - | 千斤顶推力（吨） |
| cutter_speed | REAL | - | 刀盘转速（rpm） |
| cutter_torque | REAL | - | 刀盘扭矩（kN·m） |
| excavation_speed | REAL | - | 掘进速度（mm/min） |
| grouting_pressure | REAL | - | 注浆压力（kg/cm²） |
| grouting_volume | REAL | - | 注浆量（m³/环） |
| segment_number | VARCHAR(50) | - | 管片编号 |
| excavation_duration | INTEGER | - | 掘进时间（分钟） |
| idle_duration | INTEGER | - | 闲置时间（分钟） |
| fault_duration | INTEGER | - | 故障时间（分钟） |
| excavation_distance | REAL | - | 掘进距离（米） |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**关联关系**：
- 多对一：多条掘进参数记录属于一个项目(projects)

**数据特点**：
- 时序数据，按时间顺序记录
- 用于项目详情的"掘进参数"界面显示
- 用于项目管理的"掘进信息"列表

---

### 11. prospecting_data（补勘数据表）
**用途**：存储盾构机前方地质补勘探测数据

| 字段名 | 类型 | 约束 | 单位 | 说明 |
|--------|------|------|------|------|
| prospecting_id | INTEGER | PRIMARY KEY, AUTOINCREMENT | - | 补勘ID（主键） |
| project_id | INTEGER | NOT NULL, FOREIGN KEY | - | 项目ID（外键→projects） |
| excavation_time | DATETIME | NOT NULL | - | 掘进时间 |
| stake_mark | VARCHAR(50) | - | - | 桩号 |
| mileage | REAL | - | 米 | 里程 |
| **刀盘受力数据** |
| cutter_force | REAL | - | kN | 刀盘受力 |
| cutter_penetration_resistance | REAL | - | kN | 刀具贯入阻力 |
| face_friction_torque | REAL | - | kN·m | 刀盘正面摩擦力矩 |
| **地质探测数据** |
| p_wave_velocity | REAL | - | m/s | 纵波波速 |
| s_wave_velocity | REAL | - | m/s | 横波波速 |
| wave_reflection_coeff | REAL | - | - | 波幅反射系数 |
| apparent_resistivity | REAL | - | Ω·m | 视电阻率 |
| stress_gradient | REAL | - | MPa/m | 应力梯度 |
| water_probability | REAL | - | % | 前方5m含水概率 |
| rock_properties | TEXT | - | - | 岩石物性参数描述 |
| rock_danger_level | VARCHAR(10) | - | - | 围岩危险等级(A/B/C/D) |
| **岩层参数** |
| youngs_modulus | REAL | - | GPa | 杨氏模量 |
| poisson_ratio | REAL | - | - | 泊松比 |
| wave_velocity_ratio | REAL | - | - | 横纵波速比 |
| rock_type | VARCHAR(100) | - | - | 岩层类型 |
| distribution_pattern | TEXT | - | - | 分布规律 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | - | 创建时间 |

**关联关系**：
- 多对一：多条补勘数据属于一个项目(projects)

**数据特点**：
- 时序数据，与掘进参数时间对应
- 包含三大类数据：刀盘受力、地质探测、岩层参数
- 用于超前预报和风险评估

---

## 数据库关系图（ER图）

```
┌─────────────────┐
│     users       │
│  (用户表)       │
└────────┬────────┘
         │ 1:N (创建)
         │
┌────────▼────────┐
│      news       │
│   (新闻表)      │
└─────────────────┘


┌──────────────────────────────────────────────┐
│                  projects                     │
│               (项目表-核心表)                 │
└────┬──────┬──────┬──────┬──────┬──────┬──────┘
     │1:N   │1:N   │1:N   │1:N   │1:1   │1:N
     │      │      │      │      │      │
     ▼      ▼      ▼      ▼      ▼      ▼
┌─────────┐┌──────────┐┌───────────┐┌──────────────┐
│warnings ││boreholes ││  tunnel   ││   mileage    │
│(预警表) ││(钻孔表)  ││  profiles ││   points     │
│         ││          ││(隧道轮廓) ││  (里程点)    │
└─────────┘└────┬─────┘└───────────┘└──────────────┘
                │1:N
                ▼
         ┌──────────────┐
         │borehole_layers│
         │ (钻孔地层表)  │
         └───────────────┘

     ┌──────────────────┐
     │shield_position   │
     │(盾构机位置-1:1)  │
     └──────────────────┘

     ┌──────────────────┐       ┌──────────────────┐
     │excavation_       │       │prospecting_      │
     │parameters        │       │data              │
     │(掘进参数-1:N)    │       │(补勘数据-1:N)    │
     └──────────────────┘       └──────────────────┘
```

---

## 核心业务流程

### 1. 项目创建流程
```
1. 在projects表创建项目记录
   ↓
2. 自动在mileage_points表生成里程点（每10米）
   ↓
3. 自动在shield_position表创建初始盾构机位置
   ↓
4. 可选：导入钻孔数据到boreholes和borehole_layers
   ↓
5. 可选：导入隧道轮廓到tunnel_profiles
```

### 2. 掘进数据记录流程
```
盾构机掘进
   ↓
1. 更新shield_position（盾构机位置）
   ↓
2. 记录excavation_parameters（掘进参数）
   ↓
3. 记录prospecting_data（补勘数据）
   ↓
4. 必要时创建warnings（预警信息）
   ↓
5. 更新projects.current_mileage和progress
```

### 3. 数据查询流程

#### 项目详情界面
- **工程俯视图**：查询projects + mileage_points + shield_position
- **二维视图**：查询boreholes + borehole_layers + warnings
- **三维视图**：查询boreholes + borehole_layers + tunnel_profiles
- **掘进参数**：查询excavation_parameters（最新记录）
- **补勘数据**：查询prospecting_data（最新记录）

#### 项目管理界面
- **项目总览**：查询projects列表
- **预警信息**：查询warnings（所有项目）
- **掘进信息**：查询excavation_parameters（所有项目）
- **补勘数据**：查询prospecting_data（所有项目）

---

## 数据导入接口

### 1. 钻孔数据导入
**CSV格式**（起大区间_钻孔数据.csv）：
```csv
钻孔编号,X坐标,Y坐标,地面高程,层号,层底高程,层底深度,厚度,时代成因,岩土名称,特征描述
ZK001,500.0,200.0,50.5,1,45.0,5.5,5.5,Q4al,粉质粘土,黄褐色，可塑
```

**对应表**：
- boreholes表：钻孔编号、X坐标、Y坐标、地面高程
- borehole_layers表：层号、层底高程、层底深度、厚度、时代成因、岩土名称、特征描述

### 2. 隧道轮廓导入
**CSV格式**（隧道线形_轮廓数据.csv）：
```csv
临近钻孔,里程,左上X,左上Y,左上Z,左下X,左下Y,左下Z,右上X,右上Y,右上Z,右下X,右下Y,右下Z
ZK001,2484.4,100,50,30,100,50,10,120,50,30,120,50,10
```

**对应表**：tunnel_profiles

### 3. 掘进参数导入
**通过API**：
```cpp
ExcavationParameter param;
param.setProjectId(projectId);
param.setExcavationTime(QDateTime::currentDateTime());
param.setStakeMark("K3+100.00");
// ... 设置其他参数
ExcavationParameterDAO dao;
dao.addExcavationParameter(param);
```

### 4. 补勘数据导入
**通过API**：
```cpp
ProspectingData data;
data.setProjectId(projectId);
data.setExcavationTime(QDateTime::currentDateTime());
data.setStakeMark("K3+100.00");
data.setCutterForce(3500.0);
// ... 设置其他参数
ProspectingDataDAO dao;
dao.addProspectingData(data);
```

---

## 数据维护建议

### 1. 定期清理
- excavation_parameters：建议保留最近6个月数据
- prospecting_data：建议保留最近6个月数据
- warnings：已过预警点可标记为已处理或删除

### 2. 备份策略
- 建议每天自动备份数据库文件
- 重要操作前手动备份

### 3. 索引优化
虽然当前表未显式创建索引，但建议为以下字段创建索引以提高查询性能：
```sql
-- 项目相关
CREATE INDEX idx_warnings_project ON warnings(project_id);
CREATE INDEX idx_boreholes_project ON boreholes(project_id);
CREATE INDEX idx_excavation_project ON excavation_parameters(project_id);
CREATE INDEX idx_prospecting_project ON prospecting_data(project_id);

-- 时间相关
CREATE INDEX idx_excavation_time ON excavation_parameters(excavation_time);
CREATE INDEX idx_prospecting_time ON prospecting_data(excavation_time);

-- 桩号相关
CREATE INDEX idx_excavation_stake ON excavation_parameters(stake_mark);
CREATE INDEX idx_prospecting_stake ON prospecting_data(stake_mark);
```

---

## 附录：字段枚举值说明

### 用户角色（users.role）
- `admin`：管理员（所有权限）
- `engineer`：工程师（项目管理、数据录入）
- `viewer`：查看者（仅查看权限）

### 项目状态（projects.status）
- `active`：进行中
- `completed`：已完成
- `paused`：已暂停

### 预警级别（warnings.warning_level）
- `A`：特别严重
- `B`：严重
- `C`：较重
- `D`：一般

### 预警类型（warnings.warning_type）
- 岩溶发育
- 涌水涌泥
- 岩层断裂
- 瓦斯区域

### 围岩危险等级（prospecting_data.rock_danger_level）
- `A`：极高风险
- `B`：高风险
- `C`：中风险
- `D`：低风险

### 定位方式（shield_position.positioning_method）
- `1`：GPS定位
- `2`：桩号定位
- `3`：坐标定位

---

## 技术栈说明

- **数据库**：SQLite 3.x
- **ORM框架**：Qt SQL（QSqlDatabase, QSqlQuery）
- **编程语言**：C++ (Qt 6.5.3)
- **DAO模式**：每个表对应一个DAO类
- **数据模型**：每个表对应一个Model类

---

*文档生成时间：2024-12-03*
*数据库版本：v1.0*
